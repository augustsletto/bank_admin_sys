{% extends 'baseTemplate.html' %}
{% set active_page = "management" %}
{% block title %}Management{% endblock %}

{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
<ul class=flashes>
    {% for message in messages %}
    <li>{{ message }}</li>
    {% endfor %}
</ul>
{% endif %}
{% endwith %}


<div class="container-fluid mt-3">
    <div class="row g-3">
        
        <div class="col-md">
            <div class="card h-100">
                <div class="row d-flex justify-content-between">
                    <div class="col card-title pb-2">Manage Customers</div>
                    <div class="col text-end">
                        <a class="add_acc_btn" href="{{ url_for('add_customer') }}">
                            <i class="bi bi-plus-lg py-1 px-2 tiny-buttons rounded"> Create New</i>
                        </a>
                    </div>
                </div>
    
                <div class="managedash">
                    <div class="row mt-3">
                        <div class="col-3 p-0">
                            <input type="text" id="search" placeholder=" Search customers.." class="p-0 ms-2 w-100" value="{{ q }}">
                            <!-- <button onclick="fetchCustomers()">Search</button> -->
                        </div>
                    </div>
    
                    <div class="table-container-full table-container mt-2">
                        <table class="wealt-table table-hover table text-start">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-start">
                                        <a href="#" onclick="updateSorting('customer')">
                                            <i class="bi bi-sort-alpha-down"></i> Customer
                                        </a>
                                    </th>
                                    <th scope="col" class="text-start">
                                        <a href="#" onclick="updateSorting('address')">
                                            <i class="bi bi-sort-alpha-down"></i> Address
                                        </a>
                                    </th>
                                    <th scope="col" class="text-start">
                                        <a href="#" onclick="updateSorting('city')">
                                            <i class="bi bi-sort-alpha-down"></i> City
                                        </a>
                                    </th>
                                    <th scope="col" class="text-start">
                                        <a href="#" onclick="updateSorting('national_id')">
                                            <i class="bi bi-sort-alpha-down"></i> National ID
                                        </a>
                                    </th>
                                    <th scope="col" class="text-start">
                                        <a href="#" onclick="updateSorting('id')">
                                            <i class="bi bi-sort-alpha-down"></i> #
                                        </a>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="customer-table-body">
                                {% for cust in all_customers %}
                                <tr onclick="window.location='{{ url_for('customer_list', id=cust.id) }}';" style="cursor: pointer;">
                                    <td class="text-start"><strong>{{ cust.given_name|title }} {{ cust.surname|title }}</strong><br>
                                        <span style="font-size: 0.85em; color: gray;">{{ cust.email_address|lower }}</span>
                                    </td>
                                    <td class="text-start">{{ cust.streetaddress|title }}, {{ cust.zipcode }}</td>
                                    <td class="text-start">{{ cust.city|title }}</td>
                                    <td class="text-start">{{ cust.national_id }}</td>
                                    <td class="text-start">{{ cust.id }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        

            
                </div>
            </div>
        </div>

    </div>
</div>






<!-- 


<div class="row g-4 mx-2">
    <div class="col-9 d-flex">
        <div class="p-2 card-border flex-fill p-4" style="background-color: #1d1d1d;">
            <div class="row d-flex justify-content-between">
                <div class="col card-title pb-2">Manage Customers</div>
                <div class="col text-end">
                    <a class="add_acc_btn" href="{{ url_for('add_customer') }}">
                        <i class="bi bi-plus-lg py-1 px-2 tiny-buttons rounded"> Create New</i>
                    </a>
                </div>
            </div>

            <div class="managedash">
                <div class="row mt-3">
                    <div class="col-4 border rounded p-0">
                        <input type="text" id="search" placeholder="Search customers.." class="p-0 m-0 w-100" value="{{ q }}">
                        <button onclick="fetchCustomers()">Search</button>
                    </div>
                </div>

                <div class="table-container-full table-container mt-2">
                    <table class="wealt-table table-hover table text-start">
                        <thead>
                            <tr>
                                <th scope="col" class="text-start">
                                    <a href="#" onclick="updateSorting('customer')">
                                        <i class="bi bi-sort-alpha-down"></i> Customer
                                    </a>
                                </th>
                                <th scope="col" class="text-start">
                                    <a href="#" onclick="updateSorting('address')">
                                        <i class="bi bi-sort-alpha-down"></i> Address
                                    </a>
                                </th>
                                <th scope="col" class="text-start">
                                    <a href="#" onclick="updateSorting('city')">
                                        <i class="bi bi-sort-alpha-down"></i> City
                                    </a>
                                </th>
                                <th scope="col" class="text-start">
                                    <a href="#" onclick="updateSorting('national_id')">
                                        <i class="bi bi-sort-alpha-down"></i> National ID
                                    </a>
                                </th>
                                <th scope="col" class="text-start">
                                    <a href="#" onclick="updateSorting('id')">
                                        <i class="bi bi-sort-alpha-down"></i> #
                                    </a>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="customer-table-body">
                            {% for cust in all_customers %}
                            <tr onclick="window.location='{{ url_for('customer_list', id=cust.id) }}';" style="cursor: pointer;">
                                <td class="text-start"><strong>{{ cust.given_name|title }} {{ cust.surname|title }}</strong><br>
                                    <span style="font-size: 0.85em; color: gray;">{{ cust.email_address|lower }}</span>
                                </td>
                                <td class="text-start">{{ cust.streetaddress|title }}, {{ cust.zipcode }}</td>
                                <td class="text-start">{{ cust.city|title }}</td>
                                <td class="text-start">{{ cust.national_id }}</td>
                                <td class="text-start">{{ cust.id }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>  -->

<script>
let currentSortColumn = "id";
let currentSortOrder = "asc";
let currentSearch = "";

function fetchCustomers() {
    currentSearch = document.getElementById("search").value;
    updateTable();
}

function updateSorting(column) {
    if (currentSortColumn === column) {
        currentSortOrder = currentSortOrder === "asc" ? "desc" : "asc";
    } else {
        currentSortColumn = column;
        currentSortOrder = "asc";
    }
    updateTable();
}

function updateTable() {
    fetch(`/management?q=${currentSearch}&sort_by=${currentSortColumn}&sort_order=${currentSortOrder}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        let tableBody = document.getElementById("customer-table-body");
        tableBody.innerHTML = "";

        data.forEach(cust => {
            let row = `
                <tr onclick="window.location='/customer/${cust.id}';" style="cursor: pointer;">
                    <td class="text-start"><strong>${cust.name}</strong><br>
                        <span style="font-size: 0.85em; color: gray;">${cust.email}</span>
                    </td>
                    <td class="text-start">${cust.address}</td>
                    <td class="text-start">${cust.city}</td>
                    <td class="text-start">${cust.national_id}</td>
                    <td class="text-start">${cust.id}</td>
                </tr>
            `;
            tableBody.innerHTML += row;
        });
    });
}

document.getElementById("search").addEventListener("input", fetchCustomers);
</script>

{% endblock %}
